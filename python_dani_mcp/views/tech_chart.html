<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Technologies - Daniel Avila</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a; color: #e2e8f0; padding: 24px;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    h1 { font-size: 1.5rem; margin-bottom: 8px; color: #f8fafc; }
    .subtitle { font-size: 0.875rem; color: #94a3b8; margin-bottom: 24px; }
    .chart-container {
      width: 100%; max-width: 640px;
      background: #1e293b; border-radius: 16px; padding: 24px;
      border: 1px solid #334155;
    }
    .stats {
      display: flex; gap: 16px; margin-top: 20px; flex-wrap: wrap;
      justify-content: center;
    }
    .stat {
      background: #1e293b; border: 1px solid #334155; border-radius: 12px;
      padding: 16px 24px; text-align: center; min-width: 120px;
    }
    .stat-value { font-size: 1.75rem; font-weight: 700; }
    .stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
    .loading {
      display: flex; align-items: center; justify-content: center;
      height: 400px; color: #64748b; font-size: 0.875rem;
    }
    .loading::after {
      content: ''; width: 20px; height: 20px; margin-left: 10px;
      border: 2px solid #334155; border-top-color: #34d399;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>Technologies</h1>
  <p class="subtitle">Daniel Avila's tech stack by proficiency level</p>
  <div class="chart-container">
    <div id="loading" class="loading">Loading technologies</div>
    <canvas id="techChart" style="display:none"></canvas>
  </div>
  <div id="stats" class="stats"></div>

  <script type="module">
    function renderChart(techs) {
      document.getElementById('loading').style.display = 'none';
      const canvas = document.getElementById('techChart');
      canvas.style.display = 'block';

      const advanced = techs.filter(t => (t.level || t.Level || '').toLowerCase() === 'advanced');
      const intermediate = techs.filter(t => (t.level || t.Level || '').toLowerCase() === 'intermediate');

      // Sort: advanced first, then intermediate
      const sorted = [...advanced.sort((a, b) => a.name.localeCompare(b.name)),
                       ...intermediate.sort((a, b) => a.name.localeCompare(b.name))];
      const labels = sorted.map(t => t.name);
      const values = sorted.map(t => (t.level || t.Level || '').toLowerCase() === 'advanced' ? 2 : 1);
      const colors = values.map(v => v === 2 ? '#818cf8' : '#334155');
      const borderColors = values.map(v => v === 2 ? '#a5b4fc' : '#475569');

      new Chart(canvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: colors,
            borderColor: borderColors,
            borderWidth: 1,
            borderRadius: 4,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.raw === 2 ? 'Advanced' : 'Intermediate'
              }
            }
          },
          scales: {
            x: {
              display: false, max: 2.5,
            },
            y: {
              grid: { display: false },
              ticks: { color: '#cbd5e1', font: { size: 11 } }
            }
          }
        }
      });

      // Dynamic height based on number of items
      canvas.parentElement.style.height = `${Math.max(400, sorted.length * 28 + 60)}px`;

      // Stats
      const statsEl = document.getElementById('stats');
      statsEl.innerHTML = `
        <div class="stat">
          <div class="stat-value" style="color:#818cf8">${techs.length}</div>
          <div class="stat-label">Total Technologies</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color:#a5b4fc">${advanced.length}</div>
          <div class="stat-label">Advanced</div>
        </div>
        <div class="stat">
          <div class="stat-value" style="color:#64748b">${intermediate.length}</div>
          <div class="stat-label">Intermediate</div>
        </div>
      `;
    }

    async function init() {
      try {
        const { App } = await import("https://esm.sh/@modelcontextprotocol/ext-apps@1.0.1");
        const app = new App({ name: "Tech Chart", version: "1.0.0" });
        app.ontoolresult = (result) => {
          const text = result.content?.find(c => c.type === "text")?.text;
          if (text) renderChart(JSON.parse(text));
        };
        app.connect();
      } catch {
        const res = await fetch("https://www.danielavila.me/api/technologies");
        renderChart(await res.json());
      }
    }
    init();
  </script>
</body>
</html>
